<div class="content mt-3">
  <div class="container-fluid">
    <!-- Header Mejorado -->
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-gradient-primary text-white py-3">
        <div class="row align-items-center">
          <div class="col-md-8">
            <div class="d-flex align-items-center">
              <i class="fa fa-building fa-2x mr-3"></i>
              <div>
                <h4 class="mb-0 font-weight-bold">Información del Abonado</h4>
                <small class="opacity-8">
                  <span class="badge badge-light">
                    Cuenta: {{abonado.idabonado}}
                  </span>
                </small>
              </div>
            </div>
          </div>
          <div class="col-md-4 text-right">
            <div class="btn-group">
              <button type="button" class="btn btn-light btn-sm dropdown-toggle" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                <i class="bi bi-menu-button-wide"></i> Opciones
              </button>
              <div class="dropdown-menu dropdown-menu-right shadow">
                <button class="dropdown-item" type="button" data-toggle="modal" data-target="#imprimir"
                  (click)="swEmail = false">
                  <i class="bi bi-printer mr-2"></i>Imprimir
                </button>
                <button class="dropdown-item" type="button">
                  <i class="bi-file-earmark-arrow-down mr-2"></i>Exportar
                </button>
                <button class="dropdown-item" type="button" disabled data-toggle="modal" data-target="#condonar">
                  <i class="bi bi-exclude mr-2"></i>Condonar deudas
                </button>
                <button class="dropdown-item" type="button" (click)="swEmail = true; getSinCobro()" data-toggle="modal"
                  data-target="#sendNotification">
                  <i class="bi bi-envelope mr-2"></i>Enviar notificación e-mail
                </button>
              </div>
            </div>

            <button class="btn btn-outline-light btn-sm ml-2" type="button" (click)="regresar()" [hidden]="swreturn">
              <i class="bi bi-arrow-left-circle"></i> Volver
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-0">
      <!-- Panel Información del Abonado -->
      <div class="col-sm-3">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="text-center mb-3">
              <div class="avatar-circle-lg bg-primary text-white mx-auto mb-2">
                {{ (abonado!.nombre || '?').trim().charAt(0) | uppercase }}
              </div>

              <h4 class="text-primary mb-1"><strong>Cuenta:</strong> {{abonado.idabonado}}</h4>
              <p class="text-muted">{{abonado.nombre}}</p>
            </div>

            <div class="info-list">
              <div class="info-item">
                <i class="bi bi-tag mr-2"></i>
                <div>
                  <small class="text-muted">Categoría</small>
                  <div class="font-weight-bold">{{abonado.categoria}}</div>
                </div>
              </div>

              <div class="info-item">
                <i class="bi bi-circle-fill mr-2"
                  [ngClass]="{'text-success': abonado.estado === 2 || abonado.estado === 3, 'text-warning': abonado.estado === 0}"></i>
                <div>
                  <small class="text-muted">Estado</small>
                  <div class="font-weight-bold">{{abonado.textestado}}</div>
                </div>
              </div>

              <div class="info-item">
                <i class="bi bi-speedometer2 mr-2"></i>
                <div>
                  <small class="text-muted">Nro. Medidor</small>
                  <div class="font-weight-bold">{{abonado.nromedidor}}</div>
                </div>
              </div>

              <div class="info-item">
                <i class="bi bi-calendar-event mr-2"></i>
                <div>
                  <small class="text-muted">Fecha instalación</small>
                  <div class="font-weight-bold">{{ abonado.fechainstalacion | date: 'dd/MM/y'}}</div>
                </div>
              </div>

              <div class="info-item">
                <i class="bi bi-signpost mr-2"></i>
                <div>
                  <small class="text-muted">Ruta</small>
                  <div class="font-weight-bold">{{ abonado.ruta }}</div>
                </div>
              </div>

              <div class="info-item">
                <i class="bi bi-geo-alt mr-2"></i>
                <div>
                  <small class="text-muted">Dirección</small>
                  <div class="font-weight-bold description">{{ abonado.direccionubicacion }}</div>
                </div>
              </div>

              <div class="info-item">
                <i class="bi bi-person-check mr-2"></i>
                <div>
                  <small class="text-muted">Responsable pago</small>
                  <div class="font-weight-bold">{{ abonado.responsablepago }}</div>
                </div>
              </div>

              <div class="info-item">
                <i class="bi bi-person-heart mr-2"></i>
                <div>
                  <small class="text-muted">Adulto mayor</small>
                  <div class="font-weight-bold">
                    <i class="bi bi-check2-square text-success" *ngIf="abonado.adultomayor"></i>
                    <i class="bi bi-square text-muted" *ngIf="!abonado.adultomayor"></i>
                  </div>
                </div>
              </div>

              <div class="info-item">
                <i class="bi bi-building mr-2"></i>
                <div>
                  <small class="text-muted">Municipio</small>
                  <div class="font-weight-bold">
                    <i class="bi bi-check2-square text-success" *ngIf="abonado.municipio"></i>
                    <i class="bi bi-square text-muted" *ngIf="!abonado.municipio"></i>
                  </div>
                </div>
              </div>
            </div>

            <div class="row justify-content-center mt-3" [hidden]="swreturn">
              <button class="btn btn-warning btn-sm mx-1" type="button" (click)="modiAbonado(abonado.idabonado)">
                <i class="fa fa-edit mr-1"></i>Modificar
              </button>
              <button class="btn btn-danger btn-sm mx-1" [disabled]="elimdisabled" data-toggle="modal"
                data-target="#modalEliminar">
                <i class="fa fa-times-circle mr-1"></i>Eliminar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel de Pestañas -->
      <div class="col-sm-9">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-light border-0 py-3">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" href="#planillas" data-toggle="tab" role="tab">
                  <i class="bi bi-receipt mr-1"></i>Planillas
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#historialconsumo" data-toggle="tab" role="tab"
                  (click)="lecturasxAbonado(abonado.idabonado)">
                  <i class="bi bi-graph-up mr-1"></i>Historial de Consumo
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#conveniopago" data-toggle="tab" role="tab"
                  (click)="getConveniosPago(abonado.idabonado)">
                  <i class="bi bi-file-earmark-text mr-1"></i>Convenios de pago
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#georeferencia" data-toggle="tab" role="tab" (click)="drawCuenta(abonado)">
                  <i class="bi bi-geo-alt mr-1"></i>Ubicación
                </a>
              </li>
            </ul>
          </div>

          <div class="card-body">
            <div class="tab-content">
              <!-- Pestaña Planillas -->
              <div class="tab-pane fade show active" id="planillas" role="tabpanel">
                <div class="table-container">
                  <div class="table-scroll-container">
                    <table class="table table-hover table-modern table-sm mb-0">
                      <caption class="small p-2 bg-light border-bottom">
                        Últimas <strong>{{rango}}</strong> Planillas
                        <div class="float-right">
                          <input type="number" min="1" class="form-control form-control-sm d-inline-block w-auto"
                            [(ngModel)]="rango" (change)="getFactura()">
                        </div>
                      </caption>
                      <thead class="thead-modern sticky-header">
                        <tr>
                          <th width="50" class="text-center">#</th>
                          <th width="120" class="text-center">Nro. Planilla</th>
                          <th width="100" class="text-center">Fecha</th>
                          <th class="min-width-150">Módulo</th>
                          <th width="120" class="text-center">Factura</th>
                          <th width="120" class="text-right">Valor</th>
                          <th width="100" class="text-center">Interés</th>
                          <th width="120" class="text-center">Fecha Cobro</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let factura of _facturas; let i = index" class="fila cursor-pointer"
                          data-toggle="modal" data-target="#DetalleFacturaModal"
                          (click)="getRubroxfac(factura.idfactura)">
                          <td class="text-center small">
                            <i class="bi bi-cash-coin text-success" [hidden]="validarpago(factura)"></i>
                            {{ i+1 }}
                          </td>
                          <td class="text-center">
                            <span class="badge badge-primary badge-sm">{{ factura.idfactura }}</span>
                          </td>
                          <td class="text-center small">{{factura.feccrea | formatFecha}}</td>
                          <td class="small">{{ factura.idmodulo.descripcion }}</td>
                          <td class="text-center small">{{factura.nrofactura}}</td>
                          <td class="text-right font-weight-bold small">
                            {{valorPagado(factura.idmodulo.idmodulo,factura.totaltarifa) | number: '1.2-2'}}
                          </td>
                          <td class="text-center small">{{formatInteres(factura.interescobrado) }}</td>
                          <td class="text-center small">{{ factura.fechacobro | date: 'dd/MM/y'}}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Pestaña Historial de Consumo -->
              <div class="tab-pane fade" id="historialconsumo" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Historial de Lecturas</h6>
                  <button class="btn btn-outline-primary btn-sm" (click)="grafico(abonado.idabonado)">
                    <i class="bi-bar-chart mr-1"></i>Ver Gráfico
                  </button>
                </div>

                <div *ngIf="!grafic">
                  <div class="table-container">
                    <div class="table-scroll-container">
                      <table class="table table-hover table-modern table-sm mb-0">
                        <thead class="thead-modern sticky-header">
                          <tr>
                            <th class="text-center">Emisión</th>
                            <th class="text-center">Consumo</th>
                            <th class="text-center">Anterior</th>
                            <th class="text-center">Actual</th>
                            <th class="text-center">Planilla</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let lectura of _lecturas" class="text-center fila cursor-pointer"
                            data-toggle="modal" data-target="#DetalleFacturaModal"
                            (click)="getRubroxfac(lectura.idfactura)">
                            <td class="text-left small">
                              {{ lectura.idrutaxemision_rutasxemision.idemision_emisiones.emision | nombreEmision }}
                            </td>
                            <td class="font-weight-bold small">
                              {{ lectura.lecturaactual - lectura.lecturaanterior | number: '1.0'}}
                            </td>
                            <td class="small">{{lectura.lecturaanterior | number: '1.0'}}</td>
                            <td class="small">{{ lectura.lecturaactual | number: '1.0' }}</td>
                            <td class="small">{{lectura.idfactura}}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div *ngIf="grafic" class="chart-container">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Gráfico de Consumo</h6>
                    <button class="btn btn-outline-secondary btn-sm" (click)="cerrarGrafico()">
                      <i class="bi-x-circle mr-1"></i>Cerrar Gráfico
                    </button>
                  </div>
                  <div class="chart-wrapper">
                    <canvas id="myChart"></canvas>
                  </div>
                </div>
              </div>

              <!-- Pestaña Convenios de Pago -->
              <div class="tab-pane fade" id="conveniopago" role="tabpanel">
                <div *ngIf="swconvenio">
                  <div class="table-container">
                    <div class="table-scroll-container">
                      <table class="table table-hover table-modern table-sm mb-0">
                        <thead class="thead-modern sticky-header">
                          <tr>
                            <th width="50" class="text-center">#</th>
                            <th width="150" class="text-center">Nro. Convenio</th>
                            <th width="150" class="text-right">Total Convenio</th>
                            <th width="120" class="text-right">Cuota Inicial</th>
                            <th width="120" class="text-right">Cuota Final</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let convenio of _convenios; let i = index"
                            (click)="info($event, convenio.idconvenio)" class="cursor-pointer">
                            <td class="text-center small">{{i+1}}</td>
                            <td class="text-center">
                              <span class="badge badge-info badge-sm">{{convenio.nroconvenio}}</span>
                            </td>
                            <td class="text-right font-weight-bold small">
                              ${{convenio.totalconvenio.toFixed(2)}}
                            </td>
                            <td class="text-right small">${{convenio.cuotainicial.toFixed(2)}}</td>
                            <td class="text-right small">${{convenio.cuotafinal.toFixed(2)}}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div *ngIf="!swconvenio" class="text-center py-5">
                  <div class="empty-state">
                    <i class="bi bi-file-earmark-text fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No hay convenios de pago</h5>
                    <p class="text-muted small">Esta cuenta no tiene convenios registrados</p>
                  </div>
                </div>
              </div>

              <!-- Pestaña Ubicación -->
              <div class="tab-pane fade" id="georeferencia" role="tabpanel">
                <div class="card">
                  <div class="card-body p-0">
                    <ng-container *ngIf="mostrarMapa">
                      <div id="map" style="height: 400px; border-radius: 8px;"></div>
                    </ng-container>
                    <div *ngIf="!mostrarMapa" class="text-center py-5">
                      <i class="bi bi-geo-alt fa-3x text-muted mb-3"></i>
                      <h5 class="text-muted">Ubicación no disponible</h5>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal DETALLE Planilla Mejorado -->
<div class="modal fade" id="DetalleFacturaModal" data-backdrop="static" tabindex="-1"
  aria-labelledby="DetalleFacturaModal" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white py-3">
        <div class="d-flex align-items-center w-100">
          <h5 class="modal-title mb-0">
            <i class="bi bi-receipt mr-2"></i>Detalle Planilla: <strong>{{idfactura}}</strong>
          </h5>
          <div class="ml-auto d-flex align-items-center">
            <div class="btn-group">
              <button type="button" class="btn btn-light btn-sm dropdown-toggle" data-toggle="dropdown"
                aria-expanded="false">
                <i class="bi bi-menu-button-wide"></i> Opciones
              </button>
              <div class="dropdown-menu dropdown-menu-right shadow">
                <button class="dropdown-item" type="button" [disabled]="factura.pagado != 1"
                  (click)="impComprobante(factura)">
                  <i class="bi bi-printer mr-2"></i>Comprobante pago
                </button>
                <button class="dropdown-item" type="button" [disabled]="factura.pagado != 1"
                  (click)="impFacturaElectronica(factura)">
                  <i class="bi-file-earmark-arrow-down mr-2"></i>Factura electrónica
                </button>
                <button class="dropdown-item" (click)="active = true" *ngIf="!facElectro">
                  <i class="bi bi-envelope mr-2"></i>Reenviar F. a Email
                </button>
                <button class="dropdown-item" type="button" *ngIf="usuario===1"
                  (click)="multaCalculate(factura.idfactura)">
                  <i class="bi bi-cash-coin mr-2"></i>Multas
                </button>
              </div>
            </div>
            <button class="btn btn-light btn-sm ml-2" [hidden]="facElectro" (click)="facElectro = !facElectro"
              title="Cambiar vista">
              <i class="fa fa-retweet"></i>
            </button>
            <button type="button" class="btn-close btn-close-white ml-2" data-dismiss="modal"
              aria-label="Close"></button>
          </div>
        </div>
      </div>

      <div class="modal-body">
        <div class="row" *ngIf="facElectro; else pdfelectro">
          <div class="col-md-6">
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-header bg-light py-2">
                <h6 class="mb-0 font-weight-bold">
                  <i class="bi bi-list-check mr-2"></i>Detalle de Rubros
                </h6>
              </div>
              <div class="card-body p-0">
                <div class="table-container">
                  <table class="table table-hover table-sm mb-0">
                    <thead class="thead-modern">
                      <tr>
                        <th width="50" class="text-center">#</th>
                        <th>Rubro</th>
                        <th width="120" class="text-right">Valor</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let rubroxfac of _rubrosxfac; let i=index">
                        <td class="text-center small font-weight-bold">{{i+1}}</td>
                        <td class="small">{{ rubroxfac.idrubro_rubros.descripcion}}</td>
                        <td class="text-right font-weight-bold small">
                          ${{ rubroxfac.valorunitario | number:'1.2-2'}}
                        </td>
                      </tr>
                      <tr class="table-active">
                        <td colspan="2" class="font-weight-bold text-right">TOTAL</td>
                        <td class="font-weight-bold text-right">${{ totfac | number:'1.2-2'}}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light py-2">
                <h6 class="mb-0 font-weight-bold">
                  <i class="bi bi-info-circle mr-2"></i>Información General
                </h6>
              </div>
              <div class="card-body">
                <div class="info-grid">
                  <div class="info-item" *ngIf="detalleFactura?.nrofactura">
                    <span class="info-label">Nro. Factura</span>
                    <span class="info-value badge badge-primary">{{detalleFactura?.nrofactura}}</span>
                  </div>

                  <div class="info-item">
                    <span class="info-label">Cliente</span>
                    <span class="info-value description">{{detalleFactura?.idcliente.nombre}}</span>
                  </div>

                  <div class="info-item" *ngIf="detalleFactura?.fechaeliminacion">
                    <span class="info-label">Fecha eliminación</span>
                    <span class="info-value">{{detalleFactura?.fechaeliminacion | date:'dd/MM/yyyy'}}</span>
                  </div>

                  <div class="info-item" *ngIf="detalleFactura?.fechaanulacion">
                    <span class="info-label">Fecha anulación</span>
                    <span class="info-value">{{detalleFactura?.fechaanulacion | date:'dd/MM/yyyy'}}</span>
                  </div>

                  <div class="info-item" *ngIf="detalleFactura?.fechaconvenio">
                    <span class="info-label">Fecha convenio</span>
                    <span class="info-value">{{detalleFactura?.fechaconvenio | date:'dd/MM/yyyy'}}</span>
                  </div>

                  <div class="info-item">
                    <span class="info-label">Estado F.E.</span>
                    <span class="info-value">
                      <span class="badge" [ngClass]="{
                        'badge-success': estadoFE === 'A',
                        'badge-warning': estadoFE === 'O',
                        'badge-secondary': estadoFE === 'I'
                      }">
                        {{estadoFE}}
                      </span>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <ng-template #pdfelectro>
          <div class="row">
            <div class="col-md-9">
              <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                  <iframe id="pdfViewer" src="" width="100%" height="500px"
                    style="border: none; border-radius: 8px;"></iframe>
                </div>
              </div>
            </div>
            <div class="col-md-3" *ngIf="active">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-light py-2">
                  <h6 class="mb-0 font-weight-bold">
                    <i class="bi bi-envelope mr-2"></i>Enviar por Email
                  </h6>
                </div>
                <div class="card-body">
                  <div class="form-group mb-3">
                    <label class="form-label small font-weight-bold">Correo electrónico</label>
                    <input type="email" [(ngModel)]="email" class="form-control form-control-sm"
                      placeholder="nombre@ejemplo.com">
                  </div>
                  <div class="d-flex gap-2">
                    <button type="button" (click)="active = false" class="btn btn-secondary btn-sm flex-fill">
                      <i class="bi bi-x-circle mr-1"></i>Cancelar
                    </button>
                    <button type="button" data-dismiss="modal" (click)="sendFacturaEmail()"
                      class="btn btn-success btn-sm flex-fill">
                      <i class="bi bi-send mr-1"></i>Enviar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary btn-sm" (click)="cancelarFE()" data-dismiss="modal">
          <i class="bi bi-x-circle mr-1"></i> Cerrar
        </button>
        <button type="button" class="btn btn-success btn-sm"
          [disabled]="esFE ==='A' || esFE == 'O'  || factura.pagado === 0 || usuario != 1 "
          (click)="expFacElectronica(idfactura)" data-dismiss="modal">
          <i class="bi bi-send mr-1"></i> Factura Electrónica
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL Imprimir Mejorado -->
<div class="modal fade" id="imprimir" tabindex="-1" aria-labelledby="imprimirLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white py-3">
        <h5 class="modal-title">
          <i class="bi bi-printer mr-2"></i>Imprimir Reportes
        </h5>
        <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div *ngIf="pdfView; else pdfHide">
          <div class="form-group mb-0">
            <label class="form-label small font-weight-bold">Seleccionar Reporte</label>
            <select class="form-control form-control-sm" [(ngModel)]="opt">
              <option value="0">Cartas pendientes</option>
              <option value="1">Reporte de cobros</option>
              <option value="2">Estado de cuenta</option>
            </select>
          </div>
        </div>

        <ng-template #pdfHide>
          <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
              <iframe id="pdfViewer" src="" width="100%" height="400px"
                style="border: none; border-radius: 8px;"></iframe>
            </div>
          </div>
        </ng-template>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" (click)="cancelar()">
          <i class="bi bi-x-circle mr-1"></i> Cancelar
        </button>
        <button class="btn btn-success btn-sm" (click)="setOptImprimir()">
          <i class="bi bi-check-circle mr-1"></i> Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CONDONAR DEUDAS Mejorado -->
<div class="modal fade" id="condonar" tabindex="-1" aria-labelledby="condonarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark py-3">
        <h5 class="modal-title">
          <i class="bi bi-exclude mr-2"></i>Condonar Deudas
        </h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="col-md-8">
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-header bg-light py-2">
                <h6 class="mb-0 font-weight-bold">Rubros a Condonar</h6>
              </div>
              <div class="card-body p-0">
                <div class="table-container">
                  <table class="table table-sm table-hover mb-0">
                    <thead class="thead-modern">
                      <tr>
                        <th width="80" class="text-center">Código</th>
                        <th>Descripción</th>
                        <th width="120" class="text-right">Valor</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let rubro of c_rubros">
                        <td class="text-center small">{{rubro.idrubro_rubros}}</td>
                        <td class="small">{{rubro.descripcion}}</td>
                        <td class="text-right font-weight-bold small">${{rubro.total.toFixed(2)}}</td>
                      </tr>
                      <tr class="table-active">
                        <td colspan="2" class="font-weight-bold text-right">TOTAL RUBROS</td>
                        <td class="font-weight-bold text-right">${{totalRubros.toFixed(2)}}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light py-2">
                <h6 class="mb-0 font-weight-bold">Multas</h6>
              </div>
              <div class="card-body p-0">
                <div class="table-container">
                  <table class="table table-sm table-hover mb-0">
                    <thead class="thead-modern">
                      <tr>
                        <th width="80" class="text-center">Código</th>
                        <th>Descripción</th>
                        <th width="100" class="text-right">Valor</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let m of multa">
                        <td class="text-center small">{{m.idrubro_rubros}}</td>
                        <td class="small">{{m.descripcion}}</td>
                        <td class="text-right font-weight-bold small">${{m.total.toFixed(2)}}</td>
                      </tr>
                      <tr class="table-active">
                        <td colspan="2" class="font-weight-bold text-right">TOTAL MULTAS</td>
                        <td class="font-weight-bold text-right">${{totalMultas.toFixed(2)}}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-12">
            <div class="form-group mb-0">
              <label class="form-label small font-weight-bold">Justificación de Condonación</label>
              <textarea class="form-control form-control-sm" rows="3" [(ngModel)]="razonCondonacion"
                (change)="razonCondonacionChange($event)"
                placeholder="Ingresar memorando justificando la condonación de multas e intereses de esta cuenta..."></textarea>
              <small class="form-text text-muted">Este campo es obligatorio para proceder con la condonación.</small>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" (click)="cancelar()">
          <i class="bi bi-x-circle mr-1"></i> Cancelar
        </button>
        <button class="btn btn-success btn-sm" data-dismiss="modal" [disabled]="validar()" (click)="condonarDeudas()">
          <i class="bi bi-check-circle mr-1"></i> Confirmar Condonación
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Enviar Notificación Mejorado -->
<div class="modal fade" id="sendNotification" tabindex="-1" aria-labelledby="sendNotificationLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white py-3">
        <h5 class="modal-title">
          <i class="bi bi-envelope mr-2"></i>Enviar Notificación por E-mail
        </h5>
        <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form [formGroup]="f_sendEmail" enctype="multipart/form-data">
          <div class="form-group mb-3">
            <label class="form-label small font-weight-bold">Destinatarios</label>
            <input formControlName="receptores" class="form-control form-control-sm"
              placeholder="correo1@ejemplo.com, correo2@ejemplo.com" />
            <small class="form-text text-muted">Separar múltiples correos con comas</small>
          </div>

          <div class="form-group mb-3">
            <label class="form-label small font-weight-bold">Asunto</label>
            <input formControlName="asunto" class="form-control form-control-sm" placeholder="Asunto del mensaje" />
          </div>

          <div class="form-group mb-3">
            <label class="form-label small font-weight-bold">Mensaje</label>
            <textarea formControlName="mensaje" class="form-control form-control-sm" rows="4"
              placeholder="Escriba el contenido del mensaje..."></textarea>
          </div>

          <div class="form-group mb-0">
            <label class="form-label small font-weight-bold">Archivo Adjunto</label>
            <div class="custom-file">
              <input type="file" (change)="onFileChange($event)" class="custom-file-input" id="inputGroupFile01"
                aria-describedby="inputGroupFileAddon01">
              <label class="custom-file-label" for="inputGroupFile01">
                {{nameFile || 'Seleccionar archivo...'}}
              </label>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">
          <i class="bi bi-x-circle mr-1"></i> Cancelar
        </button>
        <button type="button" class="btn btn-success btn-sm" data-dismiss="modal" (click)="sendEmail()">
          <i class="bi bi-send mr-1"></i> Enviar Notificación
        </button>
      </div>
    </div>
  </div>
</div>
