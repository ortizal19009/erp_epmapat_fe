<!-- ===========================
     HEADER ESTILO ANTERIOR
=========================== -->
<div class="content mt-1 pt-1 pl-0">
  <div class="container-fluid ">
    <div class="row mt-0 mb-1 mx-1 px-0 py-1 justify-content-start border cliente">

      <div class="col-sm-6">
        <h4 class="m-0 font-weight-bold">
          <i class="fa fa-building"></i> Abonado
          <small class="ml-2 badge badge-light">
            Cuenta: {{abonado.idabonado}}
          </small>
        </h4>
      </div>

      <div class="btn-group ml-auto mx-0">
        <!-- menú -->
        <button type="button" class="bg-transparent border-0 dropdown-toggle text-white"
                data-toggle="dropdown" aria-expanded="false">
          <i class="bi-menu-button-wide text-white"></i>
        </button>

        <div class="dropdown-menu dropdown-menu-right bg-dark roboto">
          <button class="dropdown-item" type="button"
                  data-toggle="modal" data-target="#imprimir"
                  (click)="swEmail = false">
            <i class="bi bi-printer"></i>&nbsp; Imprimir
          </button>

          <button class="dropdown-item" type="button">
            <i class="bi-file-earmark-arrow-down"></i>&nbsp; Exportar
          </button>

          <button class="dropdown-item" type="button" disabled
                  data-toggle="modal" data-target="#condonar">
            <i class="bi bi-exclude"></i>&nbsp; Condonar deudas
          </button>

          <button class="dropdown-item" type="button"
                  (click)="swEmail = true; getSinCobro()"
                  data-toggle="modal" data-target="#sendNotification">
            <i class="bi bi-envelope"></i>&nbsp; Enviar notificación e-mail
          </button>
        </div>

        <!-- regresar -->
        <button class="bg-transparent border-0" type="button"
                (click)="regresar()" [hidden]="swreturn">
          <i class="bi-arrow-left-circle text-white icoRegresar"></i>
        </button>
      </div>

    </div>
  </div>
</div>

<!-- ===========================
     CONTENIDO
=========================== -->
<div class="container-fluid">
  <div class="row mb-0">

    <!-- ===========================
         PANEL IZQUIERDO (INFO ABONADO)
    =========================== -->
    <div class="col-sm-3">
      <div class="card card-outline cardCliente mt-1">
        <div class="card-body box-profile">

          <h3 class="profile-username text-center">{{ abonado.nombre }}</h3>
          <p class="text-muted text-center">
            <span class="badge badge-light">Cuenta: {{abonado.idabonado}}</span>
          </p>

          <ul class="list-group list-group-unbordered mb-3">
            <li class="list-group-item">
              <b>Categoría</b> <a class="float-right">{{ abonado.categoria }}</a>
            </li>
            <li class="list-group-item">
              <b>Estado</b> <a class="float-right">{{ abonado.textestado }}</a>
            </li>
            <li class="list-group-item">
              <b>Nro. Medidor</b> <a class="float-right">{{ abonado.nromedidor }}</a>
            </li>
            <li class="list-group-item">
              <b>Fecha instalación</b>
              <a class="float-right">{{ abonado.fechainstalacion | date:'dd/MM/y' }}</a>
            </li>
            <li class="list-group-item">
              <b>Ruta</b> <a class="float-right">{{ abonado.ruta }}</a>
            </li>
            <li class="list-group-item">
              <b>Dirección</b>
              <a class="float-right">{{ abonado.direccionubicacion }}</a>
            </li>
            <li class="list-group-item">
              <b>Responsable pago</b>
              <a class="float-right">{{ abonado.responsablepago }}</a>
            </li>
            <li class="list-group-item">
              <b>Adulto mayor</b>
              <a class="float-right">
                <i class="bi bi-check2-square text-success" *ngIf="abonado.adultomayor"></i>
                <i class="bi bi-square text-muted" *ngIf="!abonado.adultomayor"></i>
              </a>
            </li>
            <li class="list-group-item">
              <b>Municipio</b>
              <a class="float-right">
                <i class="bi bi-check2-square text-success" *ngIf="abonado.municipio"></i>
                <i class="bi bi-square text-muted" *ngIf="!abonado.municipio"></i>
              </a>
            </li>
          </ul>

          <div class="row justify-content-center" [hidden]="swreturn">
            <button class="btn btn-warning btn-xs mx-1" type="button"
                    (click)="modiAbonado(abonado.idabonado)">
              <i class="fa fa-edit" style="font-size:24pxi"></i>
              Modificar
            </button>
            <button class="btn btn-danger btn-xs mx-1"
                    [disabled]="elimdisabled"
                    data-toggle="modal" data-target="#modalEliminar">
              <i class="fa fa-times-circle" style="font-size:24pxi"></i>
              Eliminar
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- ===========================
         PANEL DERECHO (TABS)
    =========================== -->
    <div class="col-sm-9">
      <div class="card mt-1">

        <div class="card-header cardTab">
          <ul class="nav nav-tabs card-header-tabs cardTab" role="tablist">
            <li class="nav-item">
              <a class="nav-link active cardTab" href="#planillas" data-toggle="tab" role="tab">
                <i class="bi bi-receipt"></i> Planillas
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link cardTab" href="#historialconsumo" data-toggle="tab" role="tab"
                 (click)="lecturasxAbonado(abonado.idabonado)">
                <i class="bi bi-graph-up"></i> Historial de Consumo
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link cardTab" href="#conveniopago" data-toggle="tab" role="tab"
                 (click)="getConveniosPago(abonado.idabonado)">
                <i class="bi bi-file-earmark-text"></i> Convenios de pago
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link cardTab" href="#georeferencia" data-toggle="tab" role="tab"
                 (click)="drawCuenta(abonado)">
                <i class="bi bi-geo-alt"></i> Ubicación
              </a>
            </li>
          </ul>
        </div>

        <div class="card-body">
          <div class="tab-content">

            <!-- ===========================
                 TAB PLANILLAS
            =========================== -->
            <div class="tab-pane active" id="planillas" role="tabpanel">
              <div class="post">
                <div class="user-block mb-0">

                  <table class="table table-hover table-sm table-bordered mb-0">
                    <caption class="small mark">
                      Últimas <strong>{{rango}}</strong> Planillas&nbsp;&nbsp;&nbsp;&nbsp;
                      <input type="number" min="1"
                             class="form-control form-control-sm d-inline-block w-auto"
                             [(ngModel)]="rango" (change)="getFactura()">
                    </caption>
                    <thead class="theadPlanillas">
                      <tr class="text-center">
                        <th width="60">#</th>
                        <th>Nro.</th>
                        <th>Fecha</th>
                        <th>Módulo</th>
                        <th>Factura</th>
                        <th>Valor</th>
                        <th>Interés</th>
                        <th>F.Cobro</th>
                      </tr>
                    </thead>
                    <tbody class="bodyPlanillas">
                      <tr *ngFor="let factura of _facturas; let i = index"
                          class="text-center fila"
                          data-toggle="modal" data-target="#DetalleFacturaModal"
                          (click)="getRubroxfac(factura.idfactura)">
                        <td class="small">
                          <i class="bi bi-cash-coin text-success" [hidden]="validarpago(factura)"></i>
                          {{i+1}}
                        </td>
                        <td>{{ factura.idfactura }}</td>
                        <td>{{ factura.feccrea | formatFecha }}</td>
                        <td class="text-left">{{ factura.idmodulo.descripcion }}</td>
                        <td>{{ factura.nrofactura }}</td>
                        <td class="text-right">
                          {{valorPagado(factura.idmodulo.idmodulo,factura.totaltarifa) | number:'1.2-2'}}
                        </td>
                        <td>{{ formatInteres(factura.interescobrado) }}</td>
                        <td>{{ factura.fechacobro | date:'dd/MM/y' }}</td>
                      </tr>
                    </tbody>
                  </table>

                </div>
              </div>
            </div>

            <!-- ===========================
                 TAB HISTORIAL CONSUMO
            =========================== -->
            <div class="tab-pane" id="historialconsumo" role="tabpanel">
              <div class="post">
                <div class="user-block mb-0">

                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Historial de Lecturas</h6>
                    <button class="btn btn-outline-primary btn-xs" (click)="grafico(abonado.idabonado)">
                      <i class="bi-bar-chart"></i> Ver Gráfico
                    </button>
                  </div>

                  <div *ngIf="!grafic">
                    <table class="table table-hover table-sm table-bordered mb-0">
                      <thead class="theadPlanillas">
                        <tr class="text-center">
                          <th>Emisión</th>
                          <th>Consumo</th>
                          <th>Anterior</th>
                          <th>Actual</th>
                          <th>Planilla</th>
                        </tr>
                      </thead>
                      <tbody class="bodyPlanillas">
                        <tr *ngFor="let lectura of _lecturas"
                            class="text-center fila"
                            data-toggle="modal" data-target="#DetalleFacturaModal"
                            (click)="getRubroxfac(lectura.idfactura)">
                          <td class="text-left small">
                            {{ lectura.idrutaxemision_rutasxemision.idemision_emisiones.emision | nombreEmision }}
                          </td>
                          <td class="font-weight-bold">
                            {{ (lectura.lecturaactual - lectura.lecturaanterior) | number:'1.0-0' }}
                          </td>
                          <td>{{ lectura.lecturaanterior | number:'1.0-0' }}</td>
                          <td>{{ lectura.lecturaactual | number:'1.0-0' }}</td>
                          <td>{{ lectura.idfactura }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <div *ngIf="grafic" class="text-center">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6 class="mb-0">Gráfico de Consumo</h6>
                      <button class="btn btn-outline-secondary btn-xs" (click)="cerrarGrafico()">
                        <i class="bi-x-circle"></i> Cerrar
                      </button>
                    </div>
                    <canvas id="myChart"></canvas>
                  </div>

                </div>
              </div>
            </div>

            <!-- ===========================
                 TAB CONVENIOS
            =========================== -->
            <div class="tab-pane" id="conveniopago" role="tabpanel">
              <div class="post">
                <div class="user-block mb-0">

                  <div *ngIf="swconvenio">
                    <table class="table table-hover table-sm table-bordered mb-0">
                      <thead class="theadPlanillas">
                        <tr class="text-center">
                          <th width="60">#</th>
                          <th>Nro. Convenio</th>
                          <th>Total</th>
                          <th>Cuota Inicial</th>
                          <th>Cuota Final</th>
                        </tr>
                      </thead>
                      <tbody class="bodyPlanillas">
                        <tr *ngFor="let convenio of _convenios; let i=index"
                            (click)="info($event, convenio.idconvenio)" class="text-center fila">
                          <td>{{i+1}}</td>
                          <td>{{convenio.nroconvenio}}</td>
                          <td class="text-right">${{convenio.totalconvenio.toFixed(2)}}</td>
                          <td class="text-right">${{convenio.cuotainicial.toFixed(2)}}</td>
                          <td class="text-right">${{convenio.cuotafinal.toFixed(2)}}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <div *ngIf="!swconvenio" class="text-center py-4">
                    <i class="bi bi-file-earmark-text fa-2x text-muted mb-2"></i>
                    <h6 class="text-muted">No hay convenios de pago</h6>
                  </div>

                </div>
              </div>
            </div>

            <!-- ===========================
                 TAB UBICACION
            =========================== -->
            <div class="tab-pane" id="georeferencia" role="tabpanel">
              <div class="card">
                <div class="card-body p-0">
                  <ng-container *ngIf="mostrarMapa">
                    <div id="map" style="height: 400px;"></div>
                  </ng-container>
                  <div *ngIf="!mostrarMapa" class="text-center py-4">
                    <i class="bi bi-geo-alt fa-2x text-muted mb-2"></i>
                    <h6 class="text-muted">Ubicación no disponible</h6>
                  </div>
                </div>
              </div>
            </div>

          </div><!-- tab-content -->
        </div><!-- card-body -->
      </div><!-- card -->
    </div><!-- col-sm-9 -->

  </div><!-- row -->
</div><!-- container-fluid -->


<!-- ===========================
     MODAL DETALLE FACTURA (se mantiene tu lógica)
=========================== -->
<div class="modal fade" id="DetalleFacturaModal" tabindex="-1" aria-labelledby="DetalleFacturaModal" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><strong>Planilla:</strong> {{idfactura}}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="col-sm text-center" *ngIf="!idfactura;else name">
          <i class="fa fa-spinner" aria-hidden="true"></i>
        </div>
        <ng-template #name>
          <app-info-factura [idfac]="idfactura"></app-info-factura>
        </ng-template>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-success btn-sm" data-dismiss="modal">
          <i class="fa fa-times-circle"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     MODAL IMPRIMIR (se conserva ids/eventos)
=========================== -->
<div class="modal fade" id="imprimir" tabindex="-1" aria-labelledby="imprimirLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white py-3">
        <h5 class="modal-title">
          <i class="bi bi-printer mr-2"></i>Imprimir Reportes
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div *ngIf="pdfView; else pdfHide">
          <div class="form-group mb-0">
            <label class="small font-weight-bold">Seleccionar Reporte</label>
            <select class="form-control form-control-sm" [(ngModel)]="opt">
              <option value="0">Cartas pendientes</option>
              <option value="1">Reporte de cobros</option>
              <option value="2">Estado de cuenta</option>
            </select>
          </div>
        </div>

        <ng-template #pdfHide>
          <iframe id="pdfViewer" src="" width="100%" height="400px" style="border:none;"></iframe>
        </ng-template>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" (click)="cancelar()">
          <i class="bi bi-x-circle mr-1"></i> Cancelar
        </button>
        <button class="btn btn-success btn-sm" (click)="setOptImprimir()">
          <i class="bi bi-check-circle mr-1"></i> Aceptar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     MODAL ENVIAR NOTIFICACION (se conserva ids/eventos)
=========================== -->
<div class="modal fade" id="sendNotification" tabindex="-1" aria-labelledby="sendNotificationLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white py-3">
        <h5 class="modal-title">
          <i class="bi bi-envelope mr-2"></i>Enviar Notificación por E-mail
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form [formGroup]="f_sendEmail" enctype="multipart/form-data">
          <div class="form-group mb-3">
            <label class="small font-weight-bold">Destinatarios</label>
            <input formControlName="receptores" class="form-control form-control-sm"
                   placeholder="correo1@ejemplo.com, correo2@ejemplo.com" />
            <small class="form-text text-muted">Separar múltiples correos con comas</small>
          </div>

          <div class="form-group mb-3">
            <label class="small font-weight-bold">Asunto</label>
            <input formControlName="asunto" class="form-control form-control-sm" placeholder="Asunto del mensaje" />
          </div>

          <div class="form-group mb-3">
            <label class="small font-weight-bold">Mensaje</label>
            <textarea formControlName="mensaje" class="form-control form-control-sm" rows="4"
                      placeholder="Escriba el contenido del mensaje..."></textarea>
          </div>

          <div class="form-group mb-0">
            <label class="small font-weight-bold">Archivo Adjunto</label>
            <div class="custom-file">
              <input type="file" (change)="onFileChange($event)"
                     class="custom-file-input" id="inputGroupFile01"
                     aria-describedby="inputGroupFileAddon01">
              <label class="custom-file-label" for="inputGroupFile01">
                {{nameFile || 'Seleccionar archivo...'}}
              </label>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">
          <i class="bi bi-x-circle mr-1"></i> Cancelar
        </button>
        <button type="button" class="btn btn-success btn-sm" data-dismiss="modal" (click)="sendEmail()">
          <i class="bi bi-send mr-1"></i> Enviar
        </button>
      </div>
    </div>
  </div>
</div>
