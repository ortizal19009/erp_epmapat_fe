<div class="content-header">
  <div class="container-fluid">
    <div class="row mt-4 justify-content-center text-center">
      <div class="col-sm-10 cabecera sombra border">
        <h5 class="mt-2 font-weight-bold">Modificar Cliente</h5>
      </div>
    </div>
  </div>
</div>

<div class="content">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="card card-body col-sm-10 detalle sombra">
        <form [formGroup]="formCliente">
          <div class="row">

            <div class="form-group col-md-4 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">Nacionalidad</span>
                </div>
                <select type="text" class="form-control form-control-sm" id="nacionalidad"
                  formControlName="idnacionalidad_nacionalidad" [compareWith]="compararNacionalidad"
                  (change)="changeNacion()">
                  <option [ngValue]="nac" *ngFor="let nac of nacionalidad">
                    {{ nac.descripcion }}
                  </option>
                </select>
                <div class="input-group-append">
                  <button type="button" class="btn btn-outline-success btn-xm" (click)="add_nacionalidad()">
                    <i class="bi-plus-lg"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="form-group col-md-4 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">Tipo
                    identificación</span>
                </div>
                <select type="number" class="form-control form-control-sm" id="idtpidentifica_tpidentifica"
                  formControlName="idtpidentifica_tpidentifica" [compareWith]="compararTpIdentifica"
                  (change)="changeTpidentifica()">
                  <option [ngValue]="tp" *ngFor="let tp of _tpidentifica">
                    {{ tp.codigo + ' ' +tp.nombre }}
                  </option>
                </select>
              </div>
            </div>

            <div class="form-group col-md-4 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">Identificación</span>
                </div>
                <input type="text" class="form-control text-center" formControlName="cedula" aria-label="Small"
                  aria-describedby="inputGroup-sizing-sm" maxlength="13" [ngClass]="{'is-invalid': f['cedula'].invalid && f['cedula'].touched,
                           'is-valid': f['cedula'].valid, '': f['cedula'].untouched}">
              </div>
            </div>

            <div class="form-group col-md-6 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">Nombre</span>
                </div>
                <input type="text" class="form-control" formControlName="nombre" aria-label="Small"
                  aria-describedby="inputGroup-sizing-sm" [ngClass]="{'is-invalid': f['nombre'].invalid && f['nombre'].touched,
                           'is-valid': f['nombre'].valid, '': f['nombre'].untouched}">
              </div>
            </div>

            <div class="form-group col-md-6 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">Dirección</span>
                </div>
                <input type="text" class="form-control" formControlName="direccion" aria-label="Small"
                  aria-describedby="inputGroup-sizing-sm" [ngClass]="{'is-invalid': f['direccion'].invalid && f['direccion'].touched,
                           'is-valid': f['direccion'].valid, '': f['direccion'].untouched}">
              </div>
            </div>

            <div class="form-group col-md-3 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">Teléfono</span>
                </div>
                <input type="text" class="form-control text-center" formControlName="telefono" aria-label="Small"
                  aria-describedby="inputGroup-sizing-sm" [ngClass]="{'is-invalid': f['telefono'].invalid && f['telefono'].touched,
                           'is-valid': f['telefono'].valid, '': f['telefono'].untouched}">
              </div>
            </div>

            <div class="form-group col-md-5 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">e-mail</span>
                </div>
                <input type="email" class="form-control" formControlName="email" aria-label="Small"
                  aria-describedby="inputGroup-sizing-sm" [ngClass]="{'is-invalid': f['email'].invalid && f['email'].touched,
                           'is-valid': f['email'].valid, '': f['email'].untouched}">
              </div>
            </div>

            <div class="form-group col-md-4 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">Fecha
                    nacimiento</span>
                </div>
                <input type="date" class="form-control text-center" formControlName="fechanacimiento" aria-label="Small"
                  aria-describedby="inputGroup-sizing-sm">
              </div>
            </div>

            <div class="form-group col-md-3 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">Discapacidad</span>
                </div>
                <select class="form-control form-control-sm" id="discapacitado" formControlName="discapacitado">
                  <option value=1>Si</option>
                  <option value=0>No</option>
                </select>
              </div>
            </div>

            <div class="form-group col-md-3 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">%
                    Discapacidad</span>
                </div>
                <input type="number" min="0" max="100" class="form-control form-control-sm text-center"
                  id="porcdiscapacidad" placeholder="0%-100%" formControlName="porcdiscapacidad" />
              </div>
            </div>

            <div class="form-group col-md-3 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">Exoneración</span>
                </div>
                <select type="number" class="form-control form-control-sm text-center" id="porcexonera"
                  formControlName="porcexonera">
                  <option value="0">0%</option>
                  <option value="25">25%</option>
                  <option value="50">50%</option>
                  <option value="75">75%</option>
                  <option value="100">100%</option>
                </select>
              </div>
            </div>

            <div class="form-group col-md-4 my-0 py-0">
              <div class="input-group input-group-sm mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text font-weight-bold" id="inputGroup-sizing-sm">Personeria
                    Juridica</span>
                </div>
                <select type="text" class="form-control form-control-sm" id="personeriajuridica"
                  formControlName="idpjuridica_personeriajuridica" [compareWith]="compararPersoneriaJuridica">
                  <option [ngValue]="cliente" *ngFor="let cliente of personeriajuridica">
                    {{ cliente.descripcion }}
                  </option>
                </select>
              </div>
            </div>

          </div>

          <div class="my-0 text-center">
            <button type="button" class="btn btn-success btn-sm mx-1"
              [disabled]="formCliente.pristine || !formCliente.valid" (click)="onSubmit()">
              <i class="fa fa-check-circle"></i> Aceptar
            </button>
            <button type="button" class="btn btn-outline-success btn-sm mx-1" (click)="retornar()">
              <i class="fa fa-times-circle"></i> Cancelar
            </button>
            <!-- Button trigger modal -->
            <button type="button" class="btn btn-sm btn-warning" data-toggle="modal"
              (click)="onBuscarCliente()" data-target="#modalUsuarioPass">
              Ususario/Contraseña
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>






<!-- Modal -->
<div class="modal fade" id="modalUsuarioPass" data-backdrop="static" data-keyboard="false" tabindex="-1"
  aria-labelledby="modalUsuarioPassLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 rounded-3 shadow-lg">
      <div class="modal-header bg-gradient-primary text-white">
        <div>
          <h5 class="modal-title mb-0">
            <i class="bi bi-person-gear mr-2"></i> Actualizar usuario y contraseña
          </h5>
          <small class="d-block text-white-50">
            Defina las credenciales de acceso al portal de clientes
          </small>
        </div>
        <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="container-fluid">
          <div class="row">
            <!-- Columna izquierda: datos del cliente -->
            <div class="col-md-5 mb-3">
              <div class="card border-0 bg-light rounded-3 h-100">
                <div class="card-header bg-light border-0 pb-1">
                  <h6 class="mb-0 font-weight-bold">
                    <i class="bi bi-person-lines-fill mr-1"></i> Datos del cliente
                  </h6>
                </div>
                <div class="card-body pt-2 pb-3" *ngIf="clienteSeleccionado; else sinClienteInfo">
                  <p class="small mb-2">
                    <strong>Nombre:</strong><br>
                    <span>{{ clienteSeleccionado.nombre }}</span>
                  </p>
                  <p class="small mb-2">
                    <strong>Identificación:</strong><br>
                    <span>{{ clienteSeleccionado.cedula }}</span>
                  </p>
                  <p class="small mb-0">
                    <strong>Dirección:</strong><br>
                    <span>{{ clienteSeleccionado.direccion || 'No registrada' }}</span>
                  </p>
                </div>
                <ng-template #sinClienteInfo>
                  <div class="card-body d-flex align-items-center justify-content-center">
                    <span class="text-muted small">
                      <i class="bi bi-info-circle mr-1"></i>
                      Busque un cliente para mostrar su información.
                    </span>
                  </div>
                </ng-template>
              </div>
            </div>

            <!-- Columna derecha: credenciales -->
            <div class="col-md-7">
              <form [formGroup]="formCredenciales" (ngSubmit)="onActualizarCredenciales()">
                <h6 class="fw-bold text-secondary mb-3">
                  <i class="bi bi-key-fill mr-1"></i> Credenciales de acceso
                </h6>

                <div class="mb-3">
                  <label class="form-label small font-weight-bold">Usuario de acceso</label>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text">
                      <i class="bi bi-person-circle"></i>
                    </span>
                    <input type="text" class="form-control" formControlName="username"
                      placeholder="Nombre de usuario" />
                  </div>
                  <div class="form-text text-muted small">
                    Este será el usuario que el cliente usará para iniciar sesión.
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group col-md-6 mb-3">
                    <label class="form-label small font-weight-bold">Nueva contraseña</label>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text">
                        <i class="bi bi-lock-fill"></i>
                      </span>
                      <input type="password" class="form-control" formControlName="password" placeholder="********" />
                    </div>
                  </div>

                  <div class="form-group col-md-6 mb-3">
                    <label class="form-label small font-weight-bold">Confirmar contraseña</label>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text">
                        <i class="bi bi-lock"></i>
                      </span>
                      <input type="password" class="form-control" formControlName="confirmPassword"
                        placeholder="********" />
                    </div>
                    <div *ngIf="
    formCredenciales.errors?.['passwordMismatch'] &&
    (formCredenciales.get('password')?.touched ||
    formCredenciales.get('confirmPassword')?.touched)
  " class="text-danger small mt-1">
                      Las contraseñas no coinciden.
                    </div>

                  </div>
                </div>

                <!-- Estado activo / inactivo -->
                <div class="mt-2 mb-3">
                  <label class="form-label small font-weight-bold d-block">Estado del usuario</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="switchActivo" formControlName="activo">
                    <label class="form-check-label small" for="switchActivo">
                      {{ formCredenciales.get('activo')?.value ? 'Usuario activo' : 'Usuario inactivo' }}
                    </label>
                  </div>
                  <div class="form-text text-muted small">
                    Si el usuario está inactivo, no podrá iniciar sesión en el portal.
                  </div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                  <button type="button" class="btn btn-outline-secondary btn-sm mr-2" data-dismiss="modal">
                    <i class="bi bi-x-circle mr-1"></i> Cerrar
                  </button>

                  <button type="submit" class="btn btn-success btn-sm"
                    [disabled]="loadingGuardar || formCredenciales.invalid || !clienteSeleccionado">
                    <i class="bi bi-save mr-1"></i>
                    {{ loadingGuardar ? 'Guardando...' : 'Guardar cambios' }}
                  </button>
                </div>
              </form>

              <div *ngIf="successMsg" class="alert alert-success mt-3 py-2 small">
                <i class="bi bi-check-circle-fill mr-1"></i>{{ successMsg }}
              </div>

              <div *ngIf="errorMsg" class="alert alert-danger mt-3 py-2 small">
                <i class="bi bi-exclamation-triangle-fill mr-1"></i>{{ errorMsg }}
              </div>

              <div *ngIf="!clienteSeleccionado && !loadingBuscar && !errorMsg" class="mt-3 text-muted small">
                <i class="bi bi-info-circle mr-1"></i>
                Busque un cliente para poder actualizar su usuario y contraseña.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
