<!-- CABECERA -->
<div class="content mt-1 pt-1 pl-0">
  <div class="container-fluid">
    <div class="row m-0 px-2 py-2 align-items-center cabecera border sombra">
      <div class="col-sm-5">
        <h6 class="m-0 font-weight-bold">{{ titulo }}</h6>
      </div>

      <!-- FILTRO -->
      <div class="col-sm-3 ml-auto">
        <div class="input-group input-group-sm">
          <div class="input-group-prepend">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
          </div>
          <input type="text" class="form-control text-center" placeholder="Filtrar..." [(ngModel)]="filterTerm" />
        </div>
      </div>

      <!-- BOTON GLOBAL -->
      <div class="col-sm-auto">
        <button class="btn btn-sm btn-success"
                [disabled]="selectedCount === 0"
                (click)="procesarSeleccionados()"
                data-toggle="modal"
                data-target="#impSeleccionados">
          <i class="bi bi-printer"></i>
          Imprimir seleccionados ({{ selectedCount }})
        </button>
      </div>

      <!-- REGRESAR -->
      <div class="col-sm-auto text-right">
        <button class="bg-transparent border-0" [routerLink]="['/suspensiones']">
          <i class="bi-arrow-left-circle text-white icoRegresar"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- TABLA -->
<div class="container-fluid mt-3">
  <div class="card sombra">
    <div class="card-body table-responsive">
      <table id="datos-ruta" class="table table-sm table-hover table-striped table-bordered">
        <thead class="text-center">
          <tr>
            <th style="width:40px">
              <input type="checkbox" (change)="toggleSelectAll($event)" />
            </th>
            <th>#</th>
            <th (click)="sortData('cuenta')">Cuenta</th>
            <th>Cliente</th>
            <th>Identificación</th>
            <th (click)="sortData('num_facturas')">Deudas</th>
            <th>Subtotal</th>
            <th>Interés</th>
            <th (click)="sortData('total')">Total</th>
            <th style="min-width:300px">Selección</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let abonado of datosCuentas | filter: filterTerm; let i = index">
            <!-- SELECT -->
            <td class="text-center align-middle">
              <input type="checkbox"
                     [(ngModel)]="rowUI[abonado.cuenta].selected"
                     (ngModelChange)="onRowSelectedChange(abonado)" />
            </td>

            <td class="text-center">{{ i + 1 }}</td>
            <td class="text-center">{{ abonado.cuenta }}</td>
            <td>{{ abonado.nombre }}</td>
            <td class="text-center">{{ abonado.cedula }}</td>
            <td class="text-center">{{ abonado.num_facturas }}</td>
            <td class="text-right">{{ abonado.subtotal?.toFixed(2) }}</td>
            <td class="text-right">{{ abonado.intereses?.toFixed(2) }}</td>
            <td class="text-right font-weight-bold">{{ abonado.total?.toFixed(2) }}</td>

            <!-- CONTROLES VISIBLES -->
            <td class="align-middle">
              <div class="border rounded p-2 bg-light" *ngIf="rowUI[abonado.cuenta] as ui">

                <!-- NOTIFICAR -->
                <div class="custom-control custom-checkbox mb-2">
                  <input type="checkbox"
                         class="custom-control-input"
                         [id]="'notif_' + abonado.cuenta"
                         [(ngModel)]="ui.notificar"
                         [disabled]="!ui.selected" />
                  <label class="custom-control-label" [for]="'notif_' + abonado.cuenta">
                    Notificar
                  </label>
                </div>

                <!-- ACCION -->
                <div class="custom-control custom-radio">
                  <input type="radio"
                         class="custom-control-input"
                         [id]="'susp_' + abonado.cuenta"
                         name="accion_{{ abonado.cuenta }}"
                         value="SUSPENDER"
                         [(ngModel)]="ui.accion"
                         [disabled]="!ui.selected" />
                  <label class="custom-control-label" [for]="'susp_' + abonado.cuenta">
                    Suspender
                  </label>
                </div>

                <div class="custom-control custom-radio">
                  <input type="radio"
                         class="custom-control-input"
                         [id]="'ret_' + abonado.cuenta"
                         name="accion_{{ abonado.cuenta }}"
                         value="RETIRAR_MEDIDOR"
                         [(ngModel)]="ui.accion"
                         [disabled]="!ui.selected" />
                  <label class="custom-control-label" [for]="'ret_' + abonado.cuenta">
                    Retirar medidor
                  </label>
                </div>

                <small class="text-muted d-block mt-2">
                  * Activa la selección para habilitar opciones.
                </small>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- RESUMEN -->
      <div class="mt-2 d-flex justify-content-between">
        <div class="text-muted">
          Seleccionados: <b>{{ selectedCount }}</b>
          | Notificar: <b>{{ notifyCount }}</b>
        </div>

        <button class="btn btn-sm btn-outline-secondary"
                (click)="clearSelection()"
                [disabled]="selectedCount === 0">
          Limpiar selección
        </button>
      </div>

    </div>
  </div>
</div>

<!-- MODAL: PDF de seleccionados -->
<div class="modal fade" id="impSeleccionados" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Impresión - Seleccionados</h5>
      </div>
      <div class="modal-body">
        <iframe id="pdfSeleccionadosViewer" src="" width="100%" height="600px"></iframe>
      </div>
      <div class="modal-footer">
        <button class="btn btn-sm btn-success" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


