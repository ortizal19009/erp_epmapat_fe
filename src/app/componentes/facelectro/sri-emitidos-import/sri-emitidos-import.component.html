<div class="card shadow-sm border-0 sri-card">

  <!-- HEADER -->
  <div class="card-header bg-white sri-header">
    <div class="d-flex align-items-start gap-3 flex-wrap w-100">
      <div class="me-auto">
        <div class="fw-bold fs-6">Importar Emitidos Autorizados (SRI)</div>
        <div class="text-muted small" *ngIf="archivoNombre">
          <i class="bi bi-file-earmark-text me-1"></i>
          Archivo: <span class="fw-semibold">{{ archivoNombre }}</span>
        </div>
      </div>

      <div class="d-flex gap-2 align-items-center flex-wrap sri-chips">
        <span class="badge rounded-pill bg-success-subtle text-success border">
          Válidos: <span class="fw-bold">{{ totalOk }}</span>
        </span>
        <span class="badge rounded-pill bg-danger-subtle text-danger border">
          Errores: <span class="fw-bold">{{ totalErr }}</span>
        </span>

        <button class="btn btn-outline-secondary btn-sm"
                (click)="limpiar()"
                [disabled]="cargando || cargandoEnriquecimiento || cargandoProcesamiento">
          <i class="bi bi-trash3 me-1"></i> Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- BODY -->
  <div class="card-body">

    <!-- TOOLBAR -->
    <div class="row g-2 align-items-end sri-toolbar">

      <div class="col-12 col-xl-5">
        <label class="form-label small text-muted mb-1">Archivo TXT</label>
        <input class="custom-file-input" type="file" accept=".txt" (change)="onFileSelected($event)" />
      </div>

      <div class="col-12 col-md-6 col-xl-3">
        <label class="form-label small text-muted mb-1">Buscar</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input class="form-control" type="text" [(ngModel)]="q" placeholder="Serie, clave, fecha..." />
          <button class="btn btn-outline-secondary" type="button" (click)="q='' " [disabled]="!q">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <div class="col-6 col-md-3 col-xl-2">
        <label class="form-label small text-muted mb-1">Filtros</label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" [(ngModel)]="soloErrores" id="soloErr" />
          <label class="form-check-label" for="soloErr">Solo errores</label>
        </div>
      </div>

      <div class="col-6 col-md-3 col-xl-2">
        <button class="btn btn-primary w-100"
                (click)="procesarSeleccionadas()"
                [disabled]="rows.length===0 || cargando || cargandoProcesamiento || cargandoEnriquecimiento">
          <i class="bi bi-play-circle me-1"></i>
          <span *ngIf="!cargandoProcesamiento">Procesar</span>
          <span *ngIf="cargandoProcesamiento">Procesando...</span>
        </button>
      </div>
    </div>

    <!-- ESTADOS / PROGRESO -->
    <div class="mt-3">

      <div *ngIf="cargando" class="alert alert-info py-2 mb-2">
        <i class="bi bi-hourglass-split me-1"></i> Leyendo archivo...
      </div>

      <!-- Progreso enriquecimiento -->
      <div *ngIf="cargandoEnriquecimiento" class="sri-progress mb-2">
        <div class="d-flex justify-content-between small text-muted mb-1">
          <span><i class="bi bi-database-check me-1"></i> Buscando facturas en ERP...</span>
          <span class="fw-semibold">{{ doneEnriq }}/{{ totalEnriq }} ({{ progresoEnriqPct }}%)</span>
        </div>
        <div class="progress" style="height: 10px;">
          <div class="progress-bar" role="progressbar"
               [style.width.%]="progresoEnriqPct"
               [attr.aria-valuenow]="progresoEnriqPct"
               aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>

      <!-- Progreso procesamiento -->
      <div *ngIf="cargandoProcesamiento" class="sri-progress">
        <div class="d-flex justify-content-between small text-muted mb-1">
          <span><i class="bi bi-cloud-arrow-down me-1"></i> Consultando FE + XML + Actualizando...</span>
          <span class="fw-semibold">{{ doneProc }}/{{ totalProc }} ({{ progresoProcPct }}%)</span>
        </div>
        <div class="progress" style="height: 10px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated"
               role="progressbar"
               [style.width.%]="progresoProcPct"
               [attr.aria-valuenow]="progresoProcPct"
               aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>

    </div>

    <!-- TABLE -->
    <div class="table-responsive mt-3" *ngIf="rowsFiltradas.length > 0">
      <table class="table table-sm table-hover align-middle sri-table">
        <thead class="table-light sri-thead">
          <tr>
            <th class="text-muted" style="width:40px">#</th>
            <th>Serie</th>
            <th style="min-width:260px">Clave acceso</th>
            <th>Emisión</th>
            <th>Autorización</th>
            <th class="text-end">Sin imp.</th>
            <th class="text-end">IVA</th>
            <th class="text-end">Total</th>
            <th class="text-center" style="width:110px">ID</th>
            <th style="min-width:140px">Cobro</th>
            <th style="min-width:190px">Estado</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let r of rowsFiltradas; let i = index"
              [ngClass]="{
                'table-danger': r.valido===false || r.estadoProceso==='ERROR',
                'table-warning': r.estadoProceso==='NO_ENCONTRADA' || r.estadoProceso==='SALTADA',
                'table-success': r.estadoProceso==='ACTUALIZADA'
              }">

            <td class="text-muted">{{ i + 1 }}</td>

            <td class="fw-semibold">{{ r.serie_comprobante }}</td>

            <td class="sri-clave">
              <span class="font-monospace small">{{ r.clave_acceso }}</span>
              <button class="btn btn-link btn-sm p-0 ms-2"
                      (click)="copiar(r.clave_acceso)"
                      title="Copiar clave">
                <i class="bi bi-clipboard"></i>
              </button>
            </td>

            <td>{{ r.fecha_emision }}</td>
            <td>{{ r.fecha_autorizacion }}</td>

            <td class="text-end">{{ r.valor_sin_impuestos | number:'1.2-2' }}</td>
            <td class="text-end">{{ r.iva | number:'1.2-2' }}</td>
            <td class="text-end fw-semibold">{{ r.importe_total | number:'1.2-2' }}</td>

            <td class="text-center">
              <span *ngIf="r.idfactura; else noid" class="badge bg-secondary">{{ r.idfactura }}</span>
              <ng-template #noid><span class="text-muted">—</span></ng-template>
            </td>

            <td>
              <span *ngIf="r.fechacobro; else nocobro">{{ r.fechacobro }}</span>
              <ng-template #nocobro><span class="text-muted">—</span></ng-template>
            </td>

            <td>
              <span class="badge"
                    [ngClass]="{
                      'bg-secondary': r.estadoProceso==='PENDIENTE' || r.estadoProceso==='ENCONTRADA',
                      'bg-warning text-dark': r.estadoProceso==='NO_ENCONTRADA' || r.estadoProceso==='SALTADA',
                      'bg-success': r.estadoProceso==='ACTUALIZADA',
                      'bg-danger': r.estadoProceso==='ERROR'
                    }">
                {{ r.estadoProceso || 'PENDIENTE' }}
              </span>

              <div class="small mt-1" [ngClass]="{'text-danger': r.estadoProceso==='ERROR', 'text-muted': r.estadoProceso!=='ERROR'}"
                   *ngIf="r.msg || r.error">
                {{ r.error || r.msg }}
              </div>
            </td>

          </tr>
        </tbody>
      </table>
    </div>

    <!-- EMPTY -->
    <div *ngIf="rowsFiltradas.length===0 && !cargando" class="text-muted mt-3">
      Selecciona el archivo .txt descargado del SRI para visualizarlo.
    </div>

  </div>
</div>
