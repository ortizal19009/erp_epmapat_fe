<div class="content mt-3">
  <div class="container-fluid">
    <!-- Header Mejorado -->
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-gradient-primary text-white py-3">
        <div class="row align-items-center">
          <div class="col-md-8">
            <div class="d-flex align-items-center">
              <i class="bi bi-folder-symlink fa-2x mr-3"></i>
              <div>
                <h4 class="mb-0 font-weight-bold">Gestión de Transferencias</h4>
                <small class="opacity-8">
                  <!-- Estado de caja con colores -->
                  <span class="badge" [ngClass]="estadoCajaT ? 'badge-danger' : 'badge-success'">
                    <i class="fa" [ngClass]="estadoCajaT ? 'fa-lock' : 'fa-unlock'" aria-hidden="true"></i>
                    {{ estadoCajaT ? 'Caja Cerrada' : 'Caja Abierta' }}
                  </span>
                </small>
              </div>
            </div>
          </div>
          <div class="col-md-4 text-right">
            <div class="btn-group">
              <button type="button" class="btn btn-light btn-sm dropdown-toggle"
                      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="bi bi-menu-button-wide"></i> Opciones
              </button>
              <div class="dropdown-menu dropdown-menu-right shadow">
                <button class="dropdown-item" type="button" data-toggle="modal"
                        data-target="#abrirCaja" (click)="abrirCaja()" [disabled]="!estadoCajaT">
                  <i class="bi bi-door-open mr-2"></i>Abrir caja
                </button>
                <button class="dropdown-item" type="button" data-toggle="modal"
                        data-target="#cerrarCaja" [disabled]="estadoCajaT">
                  <i class="bi bi-door-closed mr-2"></i>Cerrar caja
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" type="button" data-toggle="modal"
                        data-target="#imprimir" [disabled]="swbusca != 0">
                  <i class="bi bi-printer mr-2"></i>Imprimir
                </button>
              </div>
            </div>

            <button *ngIf="swbusca != 0" class="btn btn-outline-light btn-sm ml-2" (click)="reiniciar()">
              <i class="bi bi-arrow-left-circle"></i> Volver
            </button>
          </div>
        </div>
      </div>

      <!-- Formulario de Búsqueda -->
      <div class="card-body bg-light py-2">
        <form [formGroup]="formBuscar" (ngSubmit)="onSubmit()">
          <div class="row align-items-end">
            <div class="col-md-3">
              <label class="form-label small text-muted mb-1">Número de Cuenta</label>
              <input class="form-control form-control-sm" type="text" formControlName="cuenta"
                     placeholder="Ej: 123456">
            </div>
            <div class="col-md-3">
              <label class="form-label small text-muted mb-1">Identificación</label>
              <input class="form-control form-control-sm" type="text" formControlName="identificacion"
                     placeholder="Ej: 1723456789">
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-end h-100">
                <div class="d-flex gap-2 align-items-center">
                  <button class="btn btn-primary btn-sm px-3" type="submit">
                    <i class="fa fa-search mr-1"></i>Buscar
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal"
                          data-target="#clientesModal" (click)="clientesModal()">
                    <i class="bi bi-people mr-1"></i>Clientes
                  </button>
                  <div *ngIf="swvalido == 0" class="alert alert-warning py-1 px-2 mb-0 small">
                    <i class="fa fa-exclamation-triangle mr-1"></i>Datos inválidos
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-2" *ngIf="atransferir > 0 && !swtransferido && !estadoCajaT">
              <button type="button" class="btn btn-success btn-sm w-100" data-toggle="modal"
                      data-target="#modalTransferir" (click)="valorAtransferir(atransferir)">
                <i class="bi bi-folder-symlink mr-1"></i>
                <span class="d-block small">Transferir</span>
                <strong class="small">{{atransferir | number: '1.2-2'}}</strong>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Resto del contenido se mantiene igual -->
    <!-- Información del Cliente Compacta -->
    <div *ngIf="swbusca == 3" class="row mb-3">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body py-2">
            <div class="row align-items-center">
              <div class="col-md-8">
                <div class="d-flex align-items-center">
                  <div class="client-avatar mr-3">
                    <div class="avatar-circle-sm bg-primary text-white">
                      {{ cliente.nombre!.charAt(0) }}
                    </div>
                  </div>
                  <div>
                    <h5 class="mb-1 text-primary">{{ cliente.nombre }}</h5>
                    <div class="d-flex flex-wrap gap-3">
                      <span class="text-muted small">
                        <i class="bi bi-person-badge mr-1"></i>
                        <strong>Identificación:</strong> {{ cliente.cedula }}
                      </span>
                      <span class="text-muted small" *ngIf="cliente.direccion">
                        <i class="bi bi-geo-alt mr-1"></i>
                        <strong>Dirección:</strong> {{ cliente.direccion }}
                      </span>
                      <span class="text-muted small" *ngIf="cliente.telefono">
                        <i class="bi bi-telephone mr-1"></i>
                        <strong>Teléfono:</strong> {{ cliente.telefono }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel de Resultados -->
    <div class="row">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body p-0">
            <!-- Estados de la aplicación -->
            <div *ngIf="swbusca == 0" class="text-center py-5">
              <div class="empty-state">
                <img src="/assets/dist/img/logo.png" alt="Logo" class="empty-state-img mb-4" style="max-width: 250px;">
                <h5 class="text-muted">Sistema de Transferencias</h5>
                <p class="text-muted small">Utilice el formulario de búsqueda para comenzar</p>
              </div>
            </div>

            <div *ngIf="swbusca == 1 || swbusca == 2" class="text-center py-4">
              <div class="alert alert-info border-0 m-3 py-3">
                <div class="d-flex align-items-center justify-content-center">
                  <i class="fas fa-info-circle fa-lg mr-2"></i>
                  <div>
                    <h6 class="alert-heading mb-1">Información</h6>
                    <p class="mb-0 small" *ngIf="swbusca == 1">
                      No existe el <strong>{{ mensaje.campo }}</strong> {{ mensaje.texto }}
                    </p>
                    <p class="mb-0 small" *ngIf="swbusca == 2">
                      No tiene Planillas sin Cobrar!
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabla de Resultados -->
            <div *ngIf="swbusca == 3" class="table-container">
              <div class="table-scroll-container">
                <table class="table table-hover table-modern table-sm mb-0">
                  <thead class="thead-modern sticky-header">
                    <tr>
                      <th width="50" class="text-center">#</th>
                      <th width="100" class="text-center">Cuenta</th>
                      <th class="min-width-200">Responsable de Pago</th>
                      <th width="120" class="text-center">Planilla</th>
                      <th width="110" class="text-center">Fecha</th>
                      <th class="min-width-150">Módulo</th>
                      <th width="130" class="text-right">Valor</th>
                      <th width="80" class="text-center">
                        <div class="custom-control custom-checkbox custom-control-sm">
                          <input type="checkbox" class="custom-control-input" id="selectAll" (change)="marcarTodas($event)">
                          <label class="custom-control-label" for="selectAll"></label>
                        </div>
                      </th>
                      <th width="70" class="text-center">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let sincobro of _sincobro; let i = index"
                        [class.table-success]="sincobro.estado == 3"
                        [class.table-warning]="sincobro.idabonado == 0">
                      <td class="text-center serial-number small">{{ i+1 }}</td>
                      <td class="text-center account-number">
                        <span *ngIf="sincobro.idabonado; else noAccount" class="badge badge-light badge-sm">
                          {{ sincobro.idabonado }}
                        </span>
                        <ng-template #noAccount>
                          <span class="text-muted small">-</span>
                        </ng-template>
                      </td>
                      <td class="responsible-name small">
                        <strong>{{ sincobro.responsablePago }}</strong>
                      </td>
                      <td class="text-center invoice-number">
                        <span class="badge badge-primary badge-sm">{{ sincobro.idfactura }}</span>
                      </td>
                      <td class="text-center date-cell small">
                        {{ sincobro.feccrea | date:"dd/MM/yyyy" }}
                      </td>
                      <td class="module-name small">
                        {{ sincobro.idmodulo.descripcion }}
                      </td>
                      <td class="text-right amount-cell">
                        <span class="amount-value small">
                          ${{ valorTarifas(sincobro.totaltarifa, sincobro.comerc, sincobro.interes, sincobro.multa, sincobro.idmodulo.idmodulo, sincobro.valorbase) | number:'1.2-2' }}
                        </span>
                      </td>
                      <td class="text-center">
                        <div class="custom-control custom-checkbox custom-control-sm">
                          <input type="checkbox" class="custom-control-input"
                                 [id]="'check_' + i"
                                 [(ngModel)]="sincobro.pagado"
                                 (change)="marcarAnteriores(i)"
                                 [disabled]="sincobro.estado == 3 || swtransferido">
                          <label class="custom-control-label" [for]="'check_' + i"></label>
                        </div>
                      </td>
                      <td class="text-center">
                        <button class="btn btn-info btn-xs btn-icon" data-toggle="modal"
                                data-target="#DetallePlanillaModal"
                                (click)="getRubroxfac(sincobro.idfactura)"
                                title="Ver detalles">
                          <i class="fa fa-eye"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                  <tfoot class="table-footer">
                    <tr>
                      <td colspan="6" class="text-right total-label small">
                        <strong>TOTAL A TRANSFERIR</strong>
                      </td>
                      <td class="text-right total-amount">
                        <strong class="small">${{ sumtotal | number: '1.2-2' }}</strong>
                      </td>
                      <td colspan="2"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Notificación Flotante de Factura -->
<div *ngIf="_nroFactura != ''" class="floating-notification">
  <div class="notification-card">
    <div class="notification-content">
      <div class="notification-icon">
        <i class="bi bi-receipt"></i>
      </div>
      <div class="notification-text">
        <div class="notification-title">Factura Actual</div>
        <div class="notification-value">{{_nroFactura}}</div>
      </div>
    </div>
  </div>
</div>

<!-- MODALES CORREGIDOS -->
<!-- Modal Buscar Clientes -->
<div class="modal fade" id="clientesModal" tabindex="-1" role="dialog" aria-labelledby="clientesModalLabel" aria-hidden="true" data-backdrop="static">
  <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white py-2">
        <h5 class="modal-title" id="clientesModalLabel">Buscar Clientes</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-9">
            <form [formGroup]="formBusClientes">
              <div class="input-group input-group-sm">
                <input type="text" placeholder="Nombre ó identificación (Mínimo 5 caracteres)"
                      class="form-control form-control-sm" autofocus id="nombre_identifica"
                      formControlName="nombre_identifica" required minlength="5" />
                <div class="input-group-append">
                  <button class="btn btn-primary btn-sm" type="button" (click)="buscarClientes()"
                          [disabled]="formBusClientes.invalid">
                    <i class="fa fa-search" aria-hidden="true"></i> Buscar
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control form-control-sm" placeholder="Filtrar..." [(ngModel)]="filtro" />
          </div>
        </div>

        <div class="row mt-3" *ngIf="!formBusClientes.invalid">
          <div class="col-12">
            <div class="table-responsive">
              <table class="table table-hover table-bordered table-sm">
                <thead class="thead-dark">
                  <tr>
                    <th width="50">#</th>
                    <th>Nombre</th>
                    <th>Identificación</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let cliente of _clientes | filter:filtro; let i= index"
                      (click)="selecCliente(cliente)" style="cursor: pointer;">
                    <td class="text-center small">{{i+1}}</td>
                    <td class="small">{{cliente.nombre}}</td>
                    <td class="small">{{cliente.cedula}}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Transferir -->
<div class="modal fade" id="modalTransferir" tabindex="-1" role="dialog" aria-labelledby="modalTransferirLabel" data-backdrop="static" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-success text-white py-2">
        <h5 class="modal-title" id="modalTransferirLabel">Confirmar Transferencia</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body py-2">
        <form [formGroup]="formTransferir">
          <div class="form-group mb-2">
            <label class="font-weight-bold small">Valor a Transferir</label>
            <div class="input-group input-group-sm">
              <div class="input-group-prepend">
                <span class="input-group-text">$</span>
              </div>
              <input type="text" class="form-control form-control-sm text-right font-weight-bold"
                     formControlName="atransferir" readonly>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-success btn-sm" (click)="transferir()" data-dismiss="modal">
          <i class="fa fa-check-circle"></i> Confirmar
        </button>
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detalle Planilla -->
<div class="modal fade" id="DetallePlanillaModal" tabindex="-1" role="dialog" aria-labelledby="DetallePlanillaModalLabel">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white py-2">
        <h5 class="modal-title small" id="DetallePlanillaModalLabel">
          Detalle Planilla: {{idfactura}}
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body py-2">
        <div class="text-center mb-2">
          <h6 class="text-muted small"><strong>Consumo:</strong> {{consumo}} m<sup>3</sup></h6>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="thead-light">
              <tr>
                <th class="small">#</th>
                <th class="small">Rubro</th>
                <th class="text-right small">Valor</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let rubroxfac of _rubrosxfac; let i=index">
                <td class="text-center small">{{i+1}}</td>
                <td class="small">{{ rubroxfac.idrubro_rubros.descripcion}}</td>
                <td class="text-right small">{{ rubroxfac.valorunitario | number:'1.2-2'}}</td>
              </tr>
              <tr class="table-active">
                <td colspan="2" class="font-weight-bold small">TOTAL</td>
                <td class="font-weight-bold text-right small">{{ totfac | number:'1.2-2'}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">
          <i class="fa fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Abrir Caja -->
<div class="modal fade" id="abrirCaja" tabindex="-1" role="dialog" aria-labelledby="abrirCajaLabel" data-backdrop="static" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark py-2">
        <h5 class="modal-title small" id="abrirCajaLabel">Abrir Caja</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body py-2">
        <div class="form-group mb-2">
          <label class="small"><strong>Usuario:</strong></label>
          <p class="form-control-plaintext small">{{ _usuario.alias }}</p>
        </div>
        <div class="form-group mb-2">
          <label class="small"><strong>Establecimiento:</strong></label>
          <p class="form-control-plaintext small">{{ _establecimiento.establecimiento }}</p>
        </div>
        <div class="form-group mb-2">
          <label class="small"><strong>Nro. Factura Inicial:</strong></label>
          <p class="form-control-plaintext small">{{ _nroFactura }}</p>
        </div>

        <div class="alert alert-warning text-center mt-2 py-2" *ngIf="cajaActiva">
          <i class="fa fa-exclamation-triangle"></i>
          <strong class="small">Esta caja ya está iniciada en otro computador</strong>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-warning btn-sm" [disabled]="cajaActiva"
                data-dismiss="modal" (click)="validarCaja()">
          <i class="fa fa-check-circle"></i> Iniciar Caja
        </button>
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Cerrar Caja -->
<div class="modal fade" id="cerrarCaja" tabindex="-1" role="dialog" aria-labelledby="cerrarCajaLabel" data-backdrop="static" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white py-2">
        <h5 class="modal-title small" id="cerrarCajaLabel">Cerrar Caja</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body py-2">
        <div class="alert alert-warning text-center py-2">
          <i class="fa fa-exclamation-triangle mb-1"></i>
          <h6 class="small"><strong>¿Está seguro de cerrar la caja?</strong></h6>
          <p class="mb-0 small">Se registrará el total recaudado hasta el momento.</p>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-danger btn-sm" data-dismiss="modal" (click)="cerrarCaja()">
          <i class="fa fa-check-circle"></i> Sí, Cerrar
        </button>
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Estilos CSS Actualizados -->
<style>
/* ===== ESTADO DE CAJA CON COLORES ===== */
.badge-danger {
  background: linear-gradient(135deg, #dc3545, #c82333);
  color: white;
  padding: 0.4rem 0.8rem;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-success {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  padding: 0.4rem 0.8rem;
  font-size: 0.75rem;
  font-weight: 600;
}

/* ===== NOTIFICACIÓN FLOTANTE ===== */
.floating-notification {
  position: fixed;
  bottom: 25px;
  left: 25px;
  z-index: 1060;
  max-width: 280px;
  animation: slideInLeft 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.notification-card {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
  border-left: 4px solid #dc3545;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
}

.notification-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, #dc3545, #e35d6a);
}

.notification-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
}

.notification-content {
  display: flex;
  align-items: center;
  gap: 12px;
}

.notification-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #dc3545, #e35d6a);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.2rem;
  flex-shrink: 0;
}

.notification-text {
  flex: 1;
}

.notification-title {
  font-size: 0.8rem;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 2px;
}

.notification-value {
  font-size: 1rem;
  font-weight: 700;
  color: #dc3545;
  font-family: 'Courier New', monospace;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* ===== TABLA CON HEADER FIJADO ===== */
.table-scroll-container {
  position: relative;
  max-height: 65vh;
  overflow: auto;
  border-radius: 8px;
}

.sticky-header {
  position: sticky;
  top: 0;
  z-index: 20;
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  backdrop-filter: blur(10px);
}

.sticky-header th {
  position: sticky;
  top: 0;
  background: inherit;
  border-bottom: 2px solid #1a252f;
  padding: 12px 8px;
  font-weight: 600;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: white;
}

/* Scrollbar personalizado */
.table-scroll-container::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.table-scroll-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.table-scroll-container::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 4px;
}

.table-scroll-container::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

/* ===== ALINEACIÓN DE FORMULARIO ===== */
.card-body .row.align-items-end {
  align-items: flex-end !important;
}

.card-body .d-flex.align-items-end.h-100 {
  height: 100%;
  align-items: flex-end;
}

.form-label {
  margin-bottom: 4px;
}

.btn-sm {
  margin-bottom: 1px;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .floating-notification {
    bottom: 15px;
    left: 15px;
    right: 15px;
    max-width: none;
  }

  .badge-danger,
  .badge-success {
    font-size: 0.7rem;
    padding: 0.3rem 0.6rem;
  }
}

/* Resto de estilos se mantienen igual */
</style>
